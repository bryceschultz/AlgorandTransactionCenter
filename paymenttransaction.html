<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
<script src="algosdk.min.js"></script>
<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<link rel="stylesheet" href="style.css">
</head>
<body>
<a id="plusButton" class="fab-button green" href="#">
  <div class="plus"></div>
</a>
<div class="bgimg">
  <div class="middle">
    <h2>From</h2>
    <input id="originWalletAddress" type="text" required>
    <p>Your wallet address</p>
    <br>
    <input id="originWalletPassphrase" type="text" required>
    <p>Your wallet passphrase</p>
    <br>
    <hr>
    <br>
    <h2>To</h2>
    <input id="destinationWalletEmail" type="text" required>
    <p>Destination algorand address or email address</p>
    <br>
    <hr>
    <br>
    <h2>Amount</h2>
    <input id="transactionAmount" type="number" required>
    <p>Algos (0.1 minimum)</p>
    <br>
    <button id="submitTransaction" class="button" width="60" height="100">submit transaction</button>
  </div>
  
  <!-- The Modal -->
<div id="myModal" class="modal">

  <!-- Modal content -->
  <div class="modal-content">
	  <p id="loadingStatement"></p>
    <h4>Transaction Details:</h4>
	  <h5>Transaction ID: </h5><p id="transactionId"></p><a href="" id"transactionLink">More Details</a>
<h5>Confirmed in Round: </h5><p id="confirmationRound"></p>
	  <h5>From: </h5><p id="originAccountId"></p><a href="" id"fromAddressLink">More deatils</a>
	  <h5>To: </h5><p id="destinationAccountId"></p><a href="" id"toAddressLink">More details</a>
    <br>
    <button id="newTransactionToSameWallet" class="button" width="60" height="100">New Transaction to Same Email</button>
    <br>
    <a id="modalLink" href="paymenttransactiontowallet.html">
    <button id="newTransactionToNewWallet" class="button" width="60" height="100">New Transaction to New Email</button>
    </a>
    <br>
    <a id="modalLink" href="index.html">
    <button id="goHome" class="button" width="60" height="100">Home</button>
    </a>
  </div>
  </div>
    
  <!-- The Modal -->
<div id="plusButtonModal" class="modal">

  <!-- Modal content -->
  <div class="modal-content">
	  <button id="createWalletButton" class="button">Create Wallet</button>
	  <br>
	  <br>
	  <br>
	  <button id="fundWalletButton" class="button">Fund Wallet</button>	
  </div>
  </div>
  <!-- The Modal -->
<div id="createWalletModal" class="modal">

  <!-- Modal content -->
  <div class="modal-content">
	<p> Save your algorand address and passphrase somewhere safe as you will need these for each transaction you want to make</p>
    <h4>Algorand Address:</h4>
    <p style="overflow:scroll;" id="walletId"></p>
    <br>
    <br>
    <h4>Passphrase:</h4>
    <p style="word-wrap:break-word; display:inline-block;" id="passphrase"></p>
  </div>
  </div>
	
  <!-- The Modal -->
<div id="fundWalletModal" class="modal">
  <!-- Modal content -->
  <div class="modal-content">
	<p> Open this link in a new tab and enter your Algorand Address as the 'Target Address': </p><a href="https://bank.testnet.algorand.network/" target="_blank">testnet faucet</a>
  </div>
  </div>
	
  </div>
</div>
  
<script> 

  //Get any variables passed along with URL
  function grabLinkParams() {
    var url = new URL(window.location.href);
    var fulfillRequestTo = url.searchParams.get("fulfillRequestTo");
    console.log(fulfillRequestTo);
    $('#destinationWalletEmail').val(fulfillRequestTo);
    var fulfillRequestAmount = url.searchParams.get("fulfillRequestAmount");
    $('#transactionAmount').val(fulfillRequestAmount);
    console.log(fulfillRequestAmount);
  };
  
  //Calling function on page load
  window.onload = grabLinkParams;
  
  
  // Get the modal
var modal = document.getElementById("myModal");
  
  
  function sendTransaction(originWalletAddress, originWalletPassphrase, destinationWalletEmail, transactionAmount) {
	modal.style.display = "block";
	   $('#loadingStatement').text('Your transaction has been sent to the Algorand network and will be confirmed shortly. Please standby for confirmation.');
    var postString = "https://algorandtransactioncenter.herokuapp.com/postTransactionToNewAccount?transactionAmountInAlgos="+transactionAmount+"&originWalletPassphrase="+originWalletPassphrase+"&originWalletAddress="+originWalletAddress+"&destinationWalletEmail="+destinationWalletEmail;    
    var form = new FormData();
    var settings = {
    "url": postString,
    "method": "POST",
    "timeout": 0,
    "processData": false,
    "mimeType": "multipart/form-data",
    "contentType": false,
    "data": form
  };

  $.ajax(settings).done(function (response) {
    console.log(response);
    var respObj = JSON.parse(response);
    $('#intercept').text(respObj.Intercept);
    $('#transactionId').text(respObj.transaction_id);
    $('#originAccountId').text(respObj.origin_account_id);
    $('#destinationAccountId').text(respObj.destination_account_id);
    $('#confirmationRound').text(respObj.confirmed_round);
	var transactionLink = 'https://algoexplorer.io/tx/' + respObj.transaction_id;
	document.getElementById("transactionLink").href=transactionLink;
	var fromAddressLink = 'https://algoexplorer.io/address/' + respObj.origin_account_id;
	  document.getElementById("transactionLink").href=fromAddressLink;
	var toAddressLink = 'https://algoexplorer.io/address/' + respObj.destination_account_id;
	  document.getElementById("transactionLink").href=toAddressLink;
  });
  }
  
var newTransactionToSameWalletBtn = document.getElementById("newTransactionToSameWallet");  
 newTransactionToSameWalletBtn.onclick = function() {
   modal.style.display = "none";
 }
  
var btn = document.getElementById("submitTransaction");

// When the user clicks on the button, open the modal
btn.onclick = function() {
  var originWalletAddress = document.getElementById("originWalletAddress").value;
  console.log(originWalletAddress);
  var originWalletPassphrase = document.getElementById("originWalletPassphrase").value;
  console.log(originWalletPassphrase);
  var destinationWalletEmail = document.getElementById("destinationWalletEmail").value;
  console.log(destinationWalletEmail);
  var transactionAmount = document.getElementById("transactionAmount").value;
  console.log(transactionAmount);
  var transactionResult = sendTransaction(originWalletAddress, originWalletPassphrase, destinationWalletEmail, transactionAmount);
}

var createwalletmodal = document.getElementById("createWalletModal");
var createwalletbtn = document.getElementById("createWalletButton");

// When the user clicks on the button, open the modal
createwalletbtn.onclick = function() {
	console.log('create wallet button has fired');
	makeNewOriginWallet();
	createwalletmodal.style.display = "block";
}
	
var fundwalletbtn = document.getElementById("fundWalletButton");
var fundwalletmodal = document.getElementById("fundWalletModal");
	
// When the user clicks on the button, open the modal
fundwalletbtn.onclick = function() {
	console.log('fund wallet button has fired');
	fundwalletmodal.style.display = "block";
}

var plusbtn = document.getElementById("plusButton");
var plusbtnmodal = document.getElementById("plusButtonModal");

// When the user clicks on the button, open the modal
plusbtn.onclick = function() {
	    if (  $( this ).css( "transform" ) == 'none' ){
		$(this).css("transform","rotate(45deg)");
	    } else {
		$(this).css("transform","" );
	    }
	if (plusbtnmodal.style.display == "block") {
	plusbtnmodal.style.display = "none"; 
	} else {
	plusbtnmodal.style.display = "block";	
	}
}

window.onclick = function(event) {
  if (event.target == modal || event.target == plusbtnmodal || event.target == createwalletmodal || event.target == fundwalletmodal) {
    	modal.style.display = "none";
	plusbtnmodal.style.display = "none";
	createwalletmodal.style.display = "none";
	fundwalletmodal.style.display = "none";
	  console.log('window.onclick has fired');
	 	if (  $('#plusButton').css( "transform" ) == 'none' ){
		console.log('$#plusButton.css if has fired');
		$('#plusButton').css("transform","rotate(45deg)");
	    } else {
		$('#plusButton').css("transform","" );
	    }
  }
}

  const baseServer = 'https://testnet-algorand.api.purestake.io/ps2'
  const port = '';
  const token = {
      'X-API-Key': 'cfoNpaCzsF9xJRTOO39rF78aJRbK4fqj4W8LNv6k'
  }
  
  const algodClient = new algosdk.Algodv2(token, baseServer, port);
  let needToMakeNewDestinationWallet = false;
  let needToMakeNewOriginWallet = false;
	
  function makeNewOriginWallet() {
          var account = algosdk.generateAccount();
          var passphrase = algosdk.secretKeyToMnemonic(account.sk);
          document.getElementById("walletId").innerHTML = account.addr;
          document.getElementById("passphrase").innerHTML = passphrase;
          console.log( "My address: " + account.addr );
          console.log( "My passphrase: " + passphrase )
  }
  
</script>
</body>
</html>
